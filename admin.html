<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabarimala 2026 - Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üôè Sabarimala 2026</h1>
            <p>Admin Dashboard</p>
            <p id="groupName" style="font-size: 14px; color: #666;"></p>
        </div>

        <div id="statusMessage"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('pending')">‚è≥ Pending Approvals</button>
            <button class="tab" onclick="switchTab('registrations')">üìù Registration Requests</button>
            <button class="tab" onclick="switchTab('participants')">üë• Participants</button>
            <button class="tab" onclick="switchTab('links')">üîó User Links</button>
            <button class="tab" onclick="switchTab('expenses')">üí∞ Expenses</button>
            <button class="tab" onclick="switchTab('settlements')">üßÆ Settlements</button>
        </div>

        <!-- Pending Approvals Tab -->
        <div id="pending" class="tab-content active">
            <h2>Pending Expense Approvals</h2>
            <div id="pendingList">
                <!-- Pending expenses will be loaded here -->
            </div>
        </div>

        <!-- Registration Requests Tab -->
        <div id="registrations" class="tab-content">
            <h2>Registration Requests</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Users who want to join the group will appear here. Approve or reject their registration requests.
            </p>
            <div id="registrationList">
                <!-- Registration requests will be loaded here -->
            </div>
        </div>

        <!-- User Links Tab -->
        <div id="links" class="tab-content">
            <h2>All User Links</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Access links for all users are stored here. You can retrieve and share them if users lose their links.
            </p>
            <div id="userLinksList">
                <!-- User links will be loaded here -->
            </div>
        </div>

        <!-- Participants Tab -->
        <div id="participants" class="tab-content">
            <h2>Manage Participants</h2>
            
            <div class="form-group">
                <label>Add Participant:</label>
                <input type="text" id="participantName" placeholder="Enter name">
                <button class="btn btn-primary" onclick="addParticipant()" style="margin-top: 10px;">‚ûï Add Participant</button>
            </div>

            <div class="participant-list" id="participantList">
                <!-- Participants will be loaded here -->
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <h2>Add New Expense (Auto-Approved)</h2>
            
            <div class="form-group">
                <label>Date:</label>
                <input type="date" id="expenseDate">
            </div>

            <div class="form-group">
                <label>Description:</label>
                <input type="text" id="expenseDescription" placeholder="e.g., Dinner at restaurant">
            </div>

            <div class="form-group">
                <label>Amount (‚Çπ):</label>
                <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
            </div>

            <div class="form-group">
                <label>Paid By:</label>
                <select id="expensePaidBy">
                    <option value="">Select participant...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Split Between:</label>
                <div id="splitCheckboxes" class="split-checkboxes">
                    <!-- Checkboxes will be loaded here -->
                </div>
            </div>

            <button class="btn btn-primary" onclick="submitExpense()">‚úÖ Add Expense</button>

            <h2 style="margin-top: 40px;">All Expenses</h2>
            <div class="expense-list" id="expenseList">
                <!-- Expenses will be loaded here -->
            </div>
        </div>

        <!-- Settlements Tab -->
        <div id="settlements" class="tab-content">
            <h2>Settlement Calculations</h2>
            
            <div class="settlement-summary">
                <h3>Who Owes Whom</h3>
                <div id="settlementList">
                    <!-- Settlement calculations will be shown here -->
                </div>
            </div>

            <div class="settlement-confirmations">
                <h3>Confirmed Settlements</h3>
                <div id="confirmedSettlements">
                    <!-- Confirmed settlements will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { CONFIG, AppState, Utils } from './js/config.js';
        import { API } from './js/api.js';

        // Global functions for button handlers
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        };

        window.addParticipant = async function() {
            const name = document.getElementById('participantName').value.trim();
            
            if (!name) {
                Utils.showStatus('Please enter a participant name', 'error');
                return;
            }
            
            try {
                const result = await API.post('addParticipant', { name });
                
                if (result.success) {
                    Utils.showStatus('Participant added!', 'success');
                    document.getElementById('participantName').value = '';
                    await loadParticipants();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to add participant'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error adding participant', 'error');
            }
        };

        window.removeParticipant = async function(name) {
            if (!confirm(`Remove ${name}?`)) return;
            
            try {
                const result = await API.post('removeParticipant', { name });
                
                if (result.success) {
                    Utils.showStatus('Participant removed', 'success');
                    await loadParticipants();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to remove participant'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error removing participant', 'error');
            }
        };

        window.submitExpense = async function() {
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const paidBy = document.getElementById('expensePaidBy').value;
            
            const splitCheckboxes = document.querySelectorAll('#splitCheckboxes input:checked');
            const splitBetween = Array.from(splitCheckboxes).map(cb => cb.value);
            
            if (!date || !description || !amount || !paidBy || splitBetween.length === 0) {
                Utils.showStatus('Please fill all fields', 'error');
                return;
            }
            
            try {
                const result = await API.post('addExpense', {
                    expense: { date, description, amount, paidBy, splitBetween }
                });
                
                if (result.success) {
                    Utils.showStatus('Expense added!', 'success');
                    
                    // Clear form
                    document.getElementById('expenseDescription').value = '';
                    document.getElementById('expenseAmount').value = '';
                    document.getElementById('expensePaidBy').value = '';
                    document.querySelectorAll('#splitCheckboxes input').forEach(cb => cb.checked = false);
                    
                    await loadExpenses();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to add expense'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error adding expense', 'error');
            }
        };

        window.approveExpense = async function(index) {
            try {
                const result = await API.post('approveExpense', { index });
                
                if (result.success) {
                    Utils.showStatus('Expense approved!', 'success');
                    await loadPendingExpenses();
                    await loadExpenses();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to approve expense'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error approving expense', 'error');
            }
        };

        window.rejectExpense = async function(index) {
            if (!confirm('Reject this expense?')) return;
            
            try {
                const result = await API.post('rejectExpense', { index });
                
                if (result.success) {
                    Utils.showStatus('Expense rejected', 'success');
                    await loadPendingExpenses();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to reject expense'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error rejecting expense', 'error');
            }
        };

        window.confirmSettlement = async function(from, to, amount) {
            const confirmedBy = prompt(`Confirming settlement:\n${from} pays ‚Çπ${amount.toFixed(2)} to ${to}\n\nEnter your name to confirm:`);
            
            if (!confirmedBy || confirmedBy.trim() === '') {
                return;
            }
            
            try {
                const settlementId = `${from}-${to}`;
                const result = await API.post('confirmSettlement', {
                    settlementId, from, to, amount, confirmedBy: confirmedBy.trim()
                });
                
                if (result.success) {
                    Utils.showStatus('Settlement confirmed!', 'success');
                    await loadSettlements();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to confirm settlement'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error confirming settlement', 'error');
            }
        };

        window.approveRegistration = async function(name) {
            try {
                Utils.showStatus('Approving and generating user link...', 'info');
                const result = await API.post('approveRegistration', { name: name });
                
                if (result.success) {
                    Utils.showStatus(`Registration approved for ${name}!`, 'success');
                    await loadPendingRegistrations();
                    await loadParticipants();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to approve registration'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error approving registration', 'error');
            }
        };

        window.rejectRegistration = async function(name) {
            if (!confirm(`Reject registration request from ${name}?`)) return;
            try {
                const result = await API.post('rejectRegistration', { name: name });
                if (result.success) {
                    Utils.showStatus('Registration rejected', 'success');
                    await loadPendingRegistrations();
                } else {
                    Utils.showStatus('Error: ' + (result.error || 'Failed to reject registration'), 'error');
                }
            } catch (error) {
                Utils.showStatus('Error rejecting registration', 'error');
            }
        };

        async function loadPendingRegistrations() {
            try {
                const data = await API.get('getPendingRegistrations');
                if (data.success) {
                    const listDiv = document.getElementById('registrationList');
                    if (data.registrations.length === 0) {
                        listDiv.innerHTML = '<p>No pending registration requests. üéâ</p>';
                        return;
                    }
                    listDiv.innerHTML = data.registrations.map(reg => `
                        <div class="expense-item">
                            <div class="expense-info">
                                <div><strong>${Utils.escapeHtml(reg.name)}</strong></div>
                                <div style="color: #666; font-size: 0.9em;">Requested: ${new Date(reg.requestedAt).toLocaleString()}</div>
                            </div>
                            <div class="expense-actions">
                                <button class="btn btn-success btn-small" onclick="approveRegistration('${Utils.escapeHtml(reg.name)}')">‚úÖ Approve</button>
                                <button class="btn btn-danger btn-small" onclick="rejectRegistration('${Utils.escapeHtml(reg.name)}')">‚ùå Reject</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading registrations:', error);
            }
        }

        async function loadUserLinks() {
            try {
                const data = await API.get('getUserLinks');
                if (data.success) {
                    const listDiv = document.getElementById('userLinksList');
                    if (data.links.length === 0) {
                        listDiv.innerHTML = '<p>No user links stored yet.</p>';
                        return;
                    }
                    listDiv.innerHTML = data.links.map(link => `
                        <div class="expense-item">
                            <div class="expense-info">
                                <div><strong>${Utils.escapeHtml(link.name)}</strong> <span style="background: ${link.role === 'admin' ? '#ff6b6b' : '#4CAF50'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">${link.role.toUpperCase()}</span></div>
                                <div style="color: #666; font-size: 0.85em; word-break: break-all; margin-top: 5px;">${Utils.escapeHtml(link.link)}</div>
                                <div style="color: #999; font-size: 0.8em; margin-top: 3px;">Created: ${new Date(link.createdAt).toLocaleString()}</div>
                            </div>
                            <div class="expense-actions">
                                <button class="btn btn-primary btn-small" onclick="copyLinkToClipboard('${Utils.escapeHtml(link.link)}')">üìã Copy</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading user links:', error);
            }
        }

        window.copyLinkToClipboard = function(link) {
            navigator.clipboard.writeText(link).then(() => {
                Utils.showStatus('Link copied to clipboard!', 'success');
            });
        };

        async function loadPendingExpenses() {
            try {
                const data = await API.get('getPendingExpenses');
                
                if (data.success) {
                    const listDiv = document.getElementById('pendingList');
                    
                    if (data.pending.length === 0) {
                        listDiv.innerHTML = '<p>No pending approvals. üéâ</p>';
                        return;
                    }
                    
                    listDiv.innerHTML = data.pending.map(expense => `
                        <div class="expense-item pending">
                            <div class="expense-header">
                                <span class="expense-description">${Utils.escapeHtml(expense.description)}</span>
                                <span class="expense-amount">‚Çπ${expense.amount.toFixed(2)}</span>
                            </div>
                            <div class="expense-details">
                                <span>üìÖ ${expense.date}</span>
                                <span>üë§ Paid by: ${Utils.escapeHtml(expense.paidBy)}</span>
                                <span>üë• Split: ${expense.splitBetween.map(Utils.escapeHtml).join(', ')}</span>
                            </div>
                            <div class="expense-actions">
                                <button class="btn btn-primary btn-small" onclick="approveExpense(${expense.index})">‚úì Approve</button>
                                <button class="btn btn-danger btn-small" onclick="rejectExpense(${expense.index})">‚úó Reject</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading pending expenses:', error);
            }
        }

        async function loadParticipants() {
            try {
                const data = await API.get('getParticipants');
                
                if (data.success) {
                    AppState.participants = data.participants;
                    
                    // Update participant list
                    const listDiv = document.getElementById('participantList');
                    if (data.participants.length === 0) {
                        listDiv.innerHTML = '<p>No participants yet. Add some above.</p>';
                    } else {
                        listDiv.innerHTML = data.participants.map(p => `
                            <div class="participant-item">
                                <span>${Utils.escapeHtml(p)}</span>
                                <button class="btn btn-danger btn-icon" onclick="removeParticipant('${Utils.escapeHtml(p)}')" title="Remove participant">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        `).join('');
                    }
                    
                    // Update paid by dropdown
                    const paidBySelect = document.getElementById('expensePaidBy');
                    paidBySelect.innerHTML = '<option value="">Select participant...</option>';
                    data.participants.forEach(p => {
                        paidBySelect.innerHTML += `<option value="${Utils.escapeHtml(p)}">${Utils.escapeHtml(p)}</option>`;
                    });
                    
                    // Update split checkboxes
                    const splitDiv = document.getElementById('splitCheckboxes');
                    splitDiv.innerHTML = '';
                    data.participants.forEach(p => {
                        splitDiv.innerHTML += `
                            <label class="checkbox-label">
                                <input type="checkbox" value="${Utils.escapeHtml(p)}">
                                ${Utils.escapeHtml(p)}
                            </label>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        async function loadExpenses() {
            try {
                const data = await API.get('getExpenses');
                
                if (data.success) {
                    AppState.expenses = data.expenses;
                    
                    const listDiv = document.getElementById('expenseList');
                    
                    if (data.expenses.length === 0) {
                        listDiv.innerHTML = '<p>No expenses yet.</p>';
                        return;
                    }
                    
                    listDiv.innerHTML = data.expenses.map(expense => `
                        <div class="expense-item">
                            <div class="expense-header">
                                <span class="expense-description">${Utils.escapeHtml(expense.description)}</span>
                                <span class="expense-amount">‚Çπ${expense.amount.toFixed(2)}</span>
                            </div>
                            <div class="expense-details">
                                <span>üìÖ ${expense.date}</span>
                                <span>üë§ Paid by: ${Utils.escapeHtml(expense.paidBy)}</span>
                                <span>üë• Split: ${expense.splitBetween.map(Utils.escapeHtml).join(', ')}</span>
                                ${expense.status === 'pending' ? '<span class="status-badge pending">‚è≥ Pending</span>' : ''}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        async function loadSettlements() {
            try {
                const [expensesData, confirmationsData] = await Promise.all([
                    API.get('getExpenses'),
                    API.get('getSettlementConfirmations')
                ]);
                
                if (!expensesData.success) return;
                
                const confirmations = confirmationsData.success ? confirmationsData.confirmations : {};
                
                // Calculate settlements
                const balances = {};
                
                expensesData.expenses.forEach(expense => {
                    const share = expense.amount / expense.splitBetween.length;
                    
                    expense.splitBetween.forEach(person => {
                        if (!balances[person]) balances[person] = 0;
                        balances[person] -= share;
                    });
                    
                    if (!balances[expense.paidBy]) balances[expense.paidBy] = 0;
                    balances[expense.paidBy] += expense.amount;
                });
                
                // Optimized settlement calculation - minimizes transactions
                const settlements = [];
                const creditors = [];
                const debtors = [];
                
                Object.entries(balances).forEach(([person, balance]) => {
                    if (Math.abs(balance) < 0.01) return;
                    
                    if (balance > 0) {
                        creditors.push({ person, amount: balance });
                    } else {
                        debtors.push({ person, amount: -balance });
                    }
                });
                
                // Sort by amount descending for optimal matching
                creditors.sort((a, b) => b.amount - a.amount);
                debtors.sort((a, b) => b.amount - a.amount);
                
                // Greedy algorithm: match largest debtor with largest creditor
                while (creditors.length > 0 && debtors.length > 0) {
                    const creditor = creditors[0];
                    const debtor = debtors[0];
                    const amount = Math.min(creditor.amount, debtor.amount);
                    
                    settlements.push({
                        from: debtor.person,
                        to: creditor.person,
                        amount: amount
                    });
                    
                    creditor.amount -= amount;
                    debtor.amount -= amount;
                    
                    // Remove settled parties
                    if (creditor.amount < 0.01) creditors.shift();
                    if (debtor.amount < 0.01) debtors.shift();
                }
                
                // Display settlements
                const listDiv = document.getElementById('settlementList');
                
                if (settlements.length === 0) {
                    listDiv.innerHTML = '<p>All settled up! üéâ</p>';
                } else {
                    listDiv.innerHTML = settlements.map(s => {
                        const settlementId = `${s.from}-${s.to}`;
                        const isConfirmed = confirmations[settlementId];
                        
                        if (isConfirmed) return '';
                        
                        return `
                            <div class="settlement-item">
                                <div class="settlement-info">
                                    <span class="settlement-debtor">${Utils.escapeHtml(s.from)}</span>
                                    <span class="settlement-arrow">‚Üí</span>
                                    <span class="settlement-creditor">${Utils.escapeHtml(s.to)}</span>
                                    <span class="settlement-amount">‚Çπ${s.amount.toFixed(2)}</span>
                                </div>
                                <button class="btn btn-small" onclick="confirmSettlement('${Utils.escapeHtml(s.from)}', '${Utils.escapeHtml(s.to)}', ${s.amount})">
                                    ‚úì Confirm
                                </button>
                            </div>
                        `;
                    }).join('');
                }
                
                // Display confirmed settlements
                const confirmedDiv = document.getElementById('confirmedSettlements');
                const confirmedList = Object.entries(confirmations);
                
                if (confirmedList.length === 0) {
                    confirmedDiv.innerHTML = '<p>No confirmed settlements yet.</p>';
                } else {
                    confirmedDiv.innerHTML = confirmedList.map(([id, conf]) => `
                        <div class="settlement-item confirmed">
                            <div class="settlement-info">
                                <span>${Utils.escapeHtml(conf.from)} ‚Üí ${Utils.escapeHtml(conf.to)}: ‚Çπ${conf.amount.toFixed(2)}</span>
                            </div>
                            <div class="settlement-confirmed-by">
                                ‚úì Confirmed by ${Utils.escapeHtml(conf.confirmedBy)}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading settlements:', error);
            }
        }

        // Decrypt function (same as setup.html)
        async function decryptData(encryptedStr) {
            try {
                const base64 = encryptedStr
                    .replace(/-/g, '+')
                    .replace(/_/g, '/')
                    .padEnd(encryptedStr.length + (4 - encryptedStr.length % 4) % 4, '=');
                
                const combined = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 28);
                const encryptedData = combined.slice(28);
                
                const encoder = new TextEncoder();
                const passphrase = 'Sabarimala2026ExpenseTracker';
                const passphraseBuffer = encoder.encode(passphrase);
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passphraseBuffer,
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                const decryptedBuffer = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encryptedData
                );
                
                // Decompress data using pako
                const decompressed = pako.inflate(new Uint8Array(decryptedBuffer), { to: 'string' });
                return JSON.parse(decompressed);
            } catch (error) {
                console.error('Decryption failed:', error);
                return null;
            }
        }

        // Initialize
        (async function init() {
            // Parse URL to get encrypted token
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                document.getElementById('statusMessage').innerHTML = 
                    '<div class="status-message status-error">Invalid admin link. Please use the link generated during setup.</div>';
                return;
            }
            
            // Decrypt token
            const decryptedData = await decryptData(token);
            if (!decryptedData || !decryptedData.key || !decryptedData.apiUrl) {
                document.getElementById('statusMessage').innerHTML = 
                    '<div class="status-message status-error">Invalid or corrupted admin link. Please generate a new one.</div>';
                return;
            }
            
            CONFIG.API_URL = decryptedData.apiUrl;
            CONFIG.ACCESS_KEY = decryptedData.key;
            CONFIG.IS_ADMIN = true;
            document.getElementById('groupName').textContent = decryptedData.name;
            
            // Store admin link in sheet for backup (first time or always)
            try {
                const adminName = document.getElementById('groupName').textContent + ' Admin';
                const currentLink = window.location.href;
                await API.post('storeUserLink', {
                    name: adminName,
                    token: token,
                    link: currentLink,
                    role: 'admin'
                });
            } catch (error) {
                console.log('Note: Could not store admin link (may already exist)');
            }
            
            // Set today's date
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            // Load data
            await loadPendingExpenses();
            await loadPendingRegistrations();
            await loadParticipants();
            await loadUserLinks();
            await loadExpenses();
            await loadSettlements();
        })();
    </script>
</body>
</html>
